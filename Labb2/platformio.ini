[env:butterfly_jtag]
platform = atmelavr
board = ATmega169P
; 1. FRAMEWORK
; We leave this blank or comment it out to use "Pure C" (AVR-GCC) instead of Arduino
; framework = arduino 

; 2. COMPILER SETTINGS (Optimization & Warnings)
; -O2: Optimization level 2 (matches course)
; -Wall -Wextra -pedantic: Enable all warnings (matches course)
build_flags = 
    -O2
    -Wall
    -Wextra
    -pedantic
    -D F_CPU=8000000UL ; Tell the code we are running at 8MHz

; 3. UPLOAD SETTINGS (The "JTAG" part)
; PlatformIO needs to know exactly which JTAG tool you have.
; Common ones are "atmelice_isp", "jtagice3", or "dragon_jtag".
; Assuming Atmel-ICE for now:

upload_protocol = custom
upload_flags =
    -C
    ${platformio.packages_dir}/tool-avrdude/avrdude.conf
    -p
    m169        ; FORCE part name to 'm169'
    -c
    atmelice    ; FORCE programmer to Atmel-ICE
    -P
    usb         ; Tell avrdude to look for USB
    -e          ; Erase chip before writing

; The command that actually runs
upload_command = avrdude $UPLOAD_FLAGS -U flash:w:$SOURCE:i

; 4. FUSE SETTINGS (The "Configure Butterfly" part)
; The course asks to UNCHECK CKDIV8 (Run at 8MHz, not 1MHz)
; and UNCHECK BOOTRST (Run program immediately, don't wait for bootloader)
; 
; LFUSE: 0xE2 (Internal 8MHz Oscillator, No Divide by 8)
; HFUSE: 0x99 (JTAG Enabled, SPI Enabled, BOOTRST Unchecked/Disabled)
; EFUSE: 0xFF (Default)
board_fuses.lfuse = 0xE2
board_fuses.hfuse = 0x99
board_fuses.efuse = 0xFF

build_src_filter = +<tinythreads.c> +<mytest.c> -<main.c> 